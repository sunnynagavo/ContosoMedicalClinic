@page "/staff/calendar"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Doctor,Staff")]
@inject IAppointmentService AppointmentSvc
@inject IPatientService PatientSvc
@inject IProviderService ProviderSvc
@inject IServiceCatalogService ServiceCatalogSvc
@rendermode InteractiveServer

<PageTitle>Appointment Calendar - Contoso Medical Clinic</PageTitle>

<div class="page-content">
    <div class="container">
        <h2 class="section-title mb-4"><i class="bi bi-calendar3 me-2"></i>Appointment Calendar</h2>

        <div class="card p-4">
            <!-- Filters -->
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <label class="form-label fw-bold">Filter by Date</label>
                    <input type="date" class="form-control" @bind="_filterDate" @bind:event="onchange" />
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">Filter by Status</label>
                    <select class="form-select" @bind="_filterStatus">
                        <option value="">All Statuses</option>
                        <option value="Scheduled">Scheduled</option>
                        <option value="Confirmed">Confirmed</option>
                        <option value="Completed">Completed</option>
                        <option value="Cancelled">Cancelled</option>
                        <option value="NoShow">No Show</option>
                    </select>
                </div>
                <div class="col-md-4 d-flex align-items-end gap-2">
                    <button class="btn btn-primary" @onclick="LoadAppointments"><i class="bi bi-search me-1"></i>Filter</button>
                    <button class="btn btn-outline-secondary" @onclick="ClearFilter"><i class="bi bi-x-circle me-1"></i>Clear</button>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(_statusMessage))
            {
                <div class="alert alert-success alert-dismissible fade show">
                    <i class="bi bi-check-circle me-2"></i>@_statusMessage
                    <button type="button" class="btn-close" @onclick='() => _statusMessage = null'></button>
                </div>
            }

            @if (_appointments is null)
            {
                <div class="loading-spinner"><div class="spinner-border text-primary"></div></div>
            }
            else if (_filteredAppointments.Count == 0)
            {
                <div class="alert alert-info"><i class="bi bi-info-circle me-2"></i>No appointments found for the selected criteria.</div>
            }
            else
            {
                <div class="mb-3 d-flex gap-3 small">
                    <span><span class="badge badge-scheduled">&nbsp;</span> Scheduled: @_filteredAppointments.Count(a => a.Status == "Scheduled")</span>
                    <span><span class="badge badge-confirmed">&nbsp;</span> Confirmed: @_filteredAppointments.Count(a => a.Status == "Confirmed")</span>
                    <span><span class="badge badge-completed">&nbsp;</span> Completed: @_filteredAppointments.Count(a => a.Status == "Completed")</span>
                </div>

                <div class="table-responsive">
                    <table class="table table-clinic table-hover align-middle">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Patient</th>
                                <th>Provider</th>
                                <th>Service</th>
                                <th>Status</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var apt in _filteredAppointments)
                            {
                                <tr>
                                    <td><strong>#@apt.AppointmentId</strong></td>
                                    <td>@apt.AppointmentDate</td>
                                    <td>@apt.StartTime – @apt.EndTime</td>
                                    <td>@GetPatientName(apt.PatientId)</td>
                                    <td>@GetProviderName(apt.ProviderId)</td>
                                    <td>@GetServiceName(apt.ServiceId)</td>
                                    <td><span class="badge badge-@apt.Status.ToLower()">@apt.Status</span></td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm">
                                            @if (apt.Status == "Scheduled")
                                            {
                                                <button class="btn btn-success" title="Confirm" @onclick='() => UpdateStatus(apt.AppointmentId, apt, "Confirmed")'>
                                                    <i class="bi bi-check-lg"></i> Confirm
                                                </button>
                                                <button class="btn btn-outline-primary" title="Reschedule" @onclick="() => OpenReschedule(apt)">
                                                    <i class="bi bi-calendar2-event"></i>
                                                </button>
                                                <button class="btn btn-outline-danger" title="Cancel" @onclick='() => UpdateStatus(apt.AppointmentId, apt, "Cancelled")'>
                                                    <i class="bi bi-x-lg"></i>
                                                </button>
                                            }
                                            else if (apt.Status == "Confirmed")
                                            {
                                                <button class="btn btn-primary" title="Mark Completed" @onclick='() => UpdateStatus(apt.AppointmentId, apt, "Completed")'>
                                                    <i class="bi bi-check-circle"></i> Complete
                                                </button>
                                                <button class="btn btn-outline-primary" title="Reschedule" @onclick="() => OpenReschedule(apt)">
                                                    <i class="bi bi-calendar2-event"></i>
                                                </button>
                                                <button class="btn btn-outline-warning" title="No Show" @onclick='() => UpdateStatus(apt.AppointmentId, apt, "NoShow")'>
                                                    <i class="bi bi-person-x"></i>
                                                </button>
                                                <button class="btn btn-outline-danger" title="Cancel" @onclick='() => UpdateStatus(apt.AppointmentId, apt, "Cancelled")'>
                                                    <i class="bi bi-x-lg"></i>
                                                </button>
                                            }
                                            else
                                            {
                                                <span class="text-muted small">—</span>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>

        @if (_rescheduleTarget is not null)
        {
            <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title"><i class="bi bi-calendar2-event me-2"></i>Reschedule Appointment #@_rescheduleTarget.AppointmentId</h5>
                            <button type="button" class="btn-close btn-close-white" @onclick="CloseReschedule"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3 p-3 bg-light rounded small">
                                <strong>Patient:</strong> @GetPatientName(_rescheduleTarget.PatientId) &middot;
                                <strong>Provider:</strong> @GetProviderName(_rescheduleTarget.ProviderId) &middot;
                                <strong>Current:</strong> @_rescheduleTarget.AppointmentDate at @_rescheduleTarget.StartTime – @_rescheduleTarget.EndTime
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">New Date</label>
                                <input type="date" class="form-control" @bind="_newDate" min="@DateOnly.FromDateTime(DateTime.Today).ToString("yyyy-MM-dd")" />
                            </div>
                            <div class="row g-3">
                                <div class="col-6">
                                    <label class="form-label fw-bold">Start Time</label>
                                    <input type="time" class="form-control" @bind="_newStartTime" />
                                </div>
                                <div class="col-6">
                                    <label class="form-label fw-bold">End Time</label>
                                    <input type="time" class="form-control" @bind="_newEndTime" />
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-outline-secondary" @onclick="CloseReschedule">Cancel</button>
                            <button class="btn btn-primary" @onclick="ConfirmReschedule" disabled="@_isSaving">
                                @if (_isSaving) { <span class="spinner-border spinner-border-sm me-1"></span> }
                                <i class="bi bi-check-lg me-1"></i>Confirm Reschedule
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@code {
    private List<AppointmentDto>? _appointments;
    private Dictionary<int, string> _patientNames = new();
    private Dictionary<int, string> _providerNames = new();
    private Dictionary<int, string> _serviceNames = new();
    private DateOnly? _filterDate;
    private string _filterStatus = "";
    private string? _statusMessage;

    // Reschedule state
    private AppointmentDto? _rescheduleTarget;
    private DateTime? _newDate;
    private TimeOnly? _newStartTime;
    private TimeOnly? _newEndTime;
    private bool _isSaving;

    private List<AppointmentDto> _filteredAppointments =>
        (_appointments ?? [])
            .Where(a => string.IsNullOrEmpty(_filterStatus) || a.Status == _filterStatus)
            .OrderBy(a => a.AppointmentDate).ThenBy(a => a.StartTime)
            .ToList();

    protected override async Task OnInitializedAsync()
    {
        await Task.WhenAll(LoadLookups(), LoadAppointments());
    }

    private async Task LoadLookups()
    {
        try
        {
            var patients = await PatientSvc.GetPatientsAsync();
            _patientNames = patients.ToDictionary(p => p.PatientId, p => $"{p.FirstName} {p.LastName}");

            var providers = await ProviderSvc.GetProvidersAsync();
            _providerNames = providers.ToDictionary(p => p.ProviderId,
                p => $"{p.Title ?? "Dr."} {p.FirstName ?? ""} {p.LastName ?? $"#{p.ProviderId}"}".Trim());

            var services = await ServiceCatalogSvc.GetServicesAsync();
            _serviceNames = services.ToDictionary(s => s.ServiceId, s => s.Name);
        }
        catch { }
    }

    private async Task LoadAppointments()
    {
        try
        {
            _appointments = !_filterDate.HasValue
                ? await AppointmentSvc.GetAppointmentsAsync()
                : await AppointmentSvc.GetAppointmentsByDateAsync(_filterDate.Value.ToString("yyyy-MM-dd"));
        }
        catch { _appointments = []; }
    }

    private string GetPatientName(int id) => _patientNames.TryGetValue(id, out var n) ? n : $"Patient #{id}";
    private string GetProviderName(int id) => _providerNames.TryGetValue(id, out var n) ? n : $"Provider #{id}";
    private string GetServiceName(int id) => _serviceNames.TryGetValue(id, out var n) ? n : $"Service #{id}";

    private async Task ClearFilter() { _filterDate = null; _filterStatus = ""; await LoadAppointments(); }

    private async Task UpdateStatus(int id, AppointmentDto apt, string newStatus)
    {
        try
        {
            _statusMessage = null;
            if (newStatus == "Cancelled")
            {
                await AppointmentSvc.CancelAppointmentAsync(id, "Cancelled by staff");
            }
            else
            {
                await AppointmentSvc.UpdateStatusAsync(id, newStatus);
            }
            _statusMessage = $"Appointment #{id} updated to {newStatus}";
            await LoadAppointments();
            StateHasChanged();
        }
        catch (Exception ex) { _statusMessage = $"Error updating appointment #{id}: {ex.Message}"; }
    }

    private void OpenReschedule(AppointmentDto apt)
    {
        _rescheduleTarget = apt;
        _newDate = DateTime.TryParse(apt.AppointmentDate, out var d) ? d : DateTime.Today;
        _newStartTime = TimeOnly.TryParse(apt.StartTime, out var st) ? st : new TimeOnly(9, 0);
        _newEndTime = TimeOnly.TryParse(apt.EndTime, out var et) ? et : new TimeOnly(9, 30);
        _statusMessage = null;
    }

    private void CloseReschedule() => _rescheduleTarget = null;

    private async Task ConfirmReschedule()
    {
        if (_rescheduleTarget is null || !_newDate.HasValue || !_newStartTime.HasValue || !_newEndTime.HasValue)
        {
            _statusMessage = "Error: Please fill in all date and time fields.";
            return;
        }

        try
        {
            _isSaving = true;
            _statusMessage = null;
            var dateStr = _newDate.Value.ToString("yyyy-MM-dd");
            var startStr = _newStartTime.Value.ToString("HH:mm");
            var endStr = _newEndTime.Value.ToString("HH:mm");
            await AppointmentSvc.RescheduleAsync(_rescheduleTarget.AppointmentId, dateStr, startStr, endStr);
            _statusMessage = $"Appointment #{_rescheduleTarget.AppointmentId} rescheduled to {dateStr} at {startStr}";
            _rescheduleTarget = null;
            await LoadAppointments();
            StateHasChanged();
        }
        catch (Exception ex) { _statusMessage = $"Error rescheduling: {ex.Message}"; }
        finally { _isSaving = false; }
    }
}
