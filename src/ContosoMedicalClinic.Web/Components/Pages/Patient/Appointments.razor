@page "/patient/appointments"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@attribute [Authorize(Roles = "Patient")]
@inject IAppointmentService AppointmentSvc
@inject AuthenticationStateProvider AuthStateProvider
@rendermode InteractiveServer

<PageTitle>My Appointments - Contoso Medical Clinic</PageTitle>

<div class="page-content">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="section-title mb-0"><i class="bi bi-calendar-check me-2"></i>My Appointments</h2>
            <a href="/patient/appointments/book" class="btn btn-primary"><i class="bi bi-plus-lg me-1"></i>Book New</a>
        </div>

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>@_errorMessage</div>
        }

        @if (_appointments is null)
        {
            <div class="loading-spinner"><div class="spinner-border text-primary" role="status"></div></div>
        }
        else if (_appointments.Count == 0)
        {
            <div class="alert alert-info"><i class="bi bi-info-circle me-2"></i>You have no appointments. <a href="/patient/appointments/book">Book your first appointment!</a></div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-clinic table-hover">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Service</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var apt in _appointments)
                        {
                            <tr>
                                <td>@apt.AppointmentDate</td>
                                <td>@apt.StartTime - @apt.EndTime</td>
                                <td>Service #@apt.ServiceId</td>
                                <td><span class="badge badge-@apt.Status.ToLower()">@apt.Status</span></td>
                                <td>
                                    @if (apt.Status == "Scheduled" || apt.Status == "Confirmed")
                                    {
                                        <button class="btn btn-sm btn-outline-danger" @onclick="() => CancelAppointment(apt.AppointmentId)">
                                            <i class="bi bi-x-circle me-1"></i>Cancel
                                        </button>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

@code {
    private List<AppointmentDto>? _appointments;
    private int _patientId;
    private string? _errorMessage;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var patientIdClaim = authState.User.FindFirst("PatientId")?.Value;
            _patientId = int.TryParse(patientIdClaim, out var pid) ? pid : 1;

            _appointments = await AppointmentSvc.GetAppointmentsByPatientAsync(_patientId);
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load appointments: {ex.Message}";
            _appointments = [];
        }
    }

    private async Task CancelAppointment(int id)
    {
        try
        {
            _errorMessage = null;
            await AppointmentSvc.CancelAppointmentAsync(id, "Cancelled by patient");
            _appointments = await AppointmentSvc.GetAppointmentsByPatientAsync(_patientId);
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to cancel appointment: {ex.Message}";
        }
    }
}
